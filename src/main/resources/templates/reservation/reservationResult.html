<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì˜ˆì•½ ê²°ê³¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background: #fafbfc; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
        h2 { margin-top: 0; color: #333; }
        .info-row { margin-bottom: 12px; }
        .info-label { font-weight: 500; color: #555; }
        .info-value { color: #333; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: 500; }
        .status-complete { background: #e3f9e5; color: #2b8a3e; }
        .status-cancel { background: #fff5f5; color: #e03131; }
        hr { margin: 24px 0; border: none; border-top: 1px solid #eee; }
        .actions { margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap; }
        .btn { padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: #2e7dff; color: #fff; border: none; }
        .btn-primary:hover { background: #1a68e5; }
        .btn-secondary { background: #f1f2f6; color: #333; border: none; }
        .btn-secondary:hover { background: #e1e2e6; }
        .btn-danger { background: #ff4757; color: #fff; border: none; }
        .btn-danger:hover { background: #e03131; }
        .btn-success { background: #2b8a3e; color: #fff; border: none; }
        .btn-success:hover { background: #237032; }

        /* ë¦¬í”Œë ˆì´ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .replay-section { margin-top: 24px; padding-top: 20px; border-top: 1px solid #eee; }
        .replay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .replay-list { margin-top: 20px; }
        .replay-item { background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px; position: relative; }
        .replay-item-title { font-weight: 500; margin-bottom: 8px; }
        .replay-item-actions { position: absolute; right: 16px; top: 16px; }
        .btn-icon { background: none; border: none; color: #2e7dff; cursor: pointer; font-size: 1.1rem; }
        .btn-icon:hover { color: #0056b3; }
        .btn-icon.active { color: #ff6b6b; } /* í™œì„±í™”ëœ ëˆˆ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */

        /* ê° ë¦¬í”Œë ˆì´ í•­ëª©ë§ˆë‹¤ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ ì¶”ê°€ */
        .item-preview-container {
            margin-top: 15px;
            width: 100%;
            display: none;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .item-preview-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .replay-form { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .replay-controls { display: flex; gap: 10px; margin-top: 15px; }
        .replay-controls button { padding: 8px 16px; border-radius: 4px; font-size: 0.9rem; }
        .form-label { display: block; margin: 16px 0 8px; font-weight: 500; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .no-replay { background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center; color: #666; }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: white;
        }
        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .alert {
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        /* í˜ì´ì§€ ë¡œë”© íš¨ê³¼ */
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="fade-in">
<div id="loading-spinner" class="loading-spinner">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container">
    <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
    <div id="alert-success" class="alert alert-success" role="alert"></div>
    <div id="alert-danger" class="alert alert-danger" role="alert"></div>

    <h2>ì˜ˆì•½ ê²°ê³¼</h2>

    <div class="info-row">
        <span class="info-label">ì˜ˆì•½ë²ˆí˜¸:</span>
        <span class="info-value" th:text="${reservation.reservationId}"></span>
    </div>

    <div class="info-row">
        <span class="info-label">íšŒì›ëª…:</span>
        <span class="info-value" th:text="${reservation.memberName}"></span>
    </div>

    <div class="info-row">
        <span class="info-label">ê°•ì‚¬ëª…:</span>
        <span class="info-value" th:text="${reservation.instructorName}"></span>
    </div>

    <div class="info-row">
        <span class="info-label">ê°•ì˜ëª…:</span>
        <span class="info-value" th:text="${reservation.lectureTitle}"></span>
    </div>

    <div class="info-row">
        <span class="info-label">ì˜ˆì•½ì¼ì‹œ(ìƒì„±ì¼):</span>
        <span class="info-value" th:text="${#temporals.format(reservation.date, 'yyyy-MM-dd HH:mm')}"></span>
    </div>

    <div class="info-row">
        <span class="info-label">ìƒíƒœ:</span>
        <span class="status" th:classappend="${reservation.status == 'ì˜ˆì•½ì™„ë£Œ' ? 'status-complete' : (reservation.status == 'ì·¨ì†Œ' ? 'status-cancel' : '')}"
              th:text="${reservation.status}"></span>
    </div>

    <div class="info-row" th:if="${reservation.status == 'ì·¨ì†Œ' && reservation.cancelReason != null}">
        <span class="info-label">ì·¨ì†Œ ì‚¬ìœ :</span>
        <span class="info-value" th:text="${reservation.cancelReason}">-</span>
    </div>

    <hr>

    <div class="info-row">
        <div class="info-label">ìš”ì²­ì‚¬í•­:</div>
        <div class="info-value" th:text="${reservation.requestDetail ?: '-'}"></div>
    </div>

    <div class="info-row">
        <div class="info-label">ê°•ì˜ ì¼ì •(ì˜ˆì•½ì¼):</div>
        <div class="info-value" th:text="${reservation.scheduleDate ?: '-'}"></div>
    </div>

    <!-- ë¦¬í”Œë ˆì´ ì„¹ì…˜ (ê°œì„ ë¨) -->
    <div class="replay-section">
        <div class="replay-header">
            <h3 style="margin: 0;">ë¦¬í”Œë ˆì´</h3>
        </div>

        <p>ì´ ì˜ˆì•½ì— ë“±ë¡ëœ ê°•ì˜ ë¦¬í”Œë ˆì´ ëª©ë¡ì…ë‹ˆë‹¤.</p>

        <!-- ë¦¬í”Œë ˆì´ ëª©ë¡ -->
        <div id="replay-list" class="replay-list">
            <!-- ë¦¬í”Œë ˆì´ í•­ëª©ë“¤ (ìˆëŠ” ê²½ìš°) -->
            <div th:if="${reservation.replays != null && !reservation.replays.isEmpty()}"
                 th:each="replay, replayStat : ${reservation.replays}"
                 class="replay-item"
                 th:data-id="${replay.replayId}">
                <div class="replay-item-title" th:text="'ë¦¬í”Œë ˆì´ ' + (${replayStat.index} + 1)"></div>
                <div th:if="${replay.date != null}" style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                    <span th:text="'ì—…ë¡œë“œ: ' + ${#temporals.format(replay.date, 'yyyy-MM-dd HH:mm')}"></span>
                </div>
                <div class="replay-item-actions">
                    <button type="button" class="btn-icon view-replay" th:data-url="${replay.fileUrl}">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <!-- ê° ë¦¬í”Œë ˆì´ í•­ëª©ë§ˆë‹¤ ê°œë³„ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
                <div class="item-preview-container"></div>
            </div>

            <!-- ë¦¬í”Œë ˆì´ê°€ ì—†ëŠ” ê²½ìš° -->
            <div th:if="${reservation.replays == null || reservation.replays.isEmpty()}" class="no-replay">
                <p>ì•„ì§ ë“±ë¡ëœ ë¦¬í”Œë ˆì´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <div th:if="${reservation.status != 'ì·¨ì†Œ'}">
                    <p>ì˜ˆì•½ í™”ë©´ì—ì„œ ë¦¬í”Œë ˆì´ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¦¬í”Œë ˆì´ ëª©ë¡ ë²„íŠ¼ ì‚­ì œí•˜ê³  í•„ìš”í•œ ë²„íŠ¼ë§Œ ìœ ì§€ -->
    <div class="actions">
        <a id="reservation-again-btn" th:href="@{/reservation/new(lectureId=${reservation.lectureId},memberId=${reservation.memberId})}" class="btn btn-primary">ë‹¤ì‹œ ì˜ˆì•½í•˜ê¸°</a>

        <span th:if="${reservation.status!='ì·¨ì†Œ'}">
                <form th:action="@{/payments/request}" method="post">
                    <input type="hidden" name="reservationId" th:value="${reservationId}" />
                    <button class="btn btn-primary" type="submit">ê²°ì œí•˜ê¸°</button>
                </form>
        </span>

        <a id="reservation-cancel-btn" th:if="${reservation.status != 'ì·¨ì†Œ'}" th:href="@{/reservation/{id}/cancel(id=${reservation.reservationId})}" class="btn btn-danger">ì˜ˆì•½ ì·¨ì†Œí•˜ê¸°</a>
    </div>

</div>

<script>
    $(function() {
        // í”Œë˜ì‹œ ë©”ì‹œì§€ í™•ì¸ ë° í‘œì‹œ (ìˆ˜ì •ë¨)
        var message = /*[[${message ?: 'null'}]]*/ 'null';
        var error = /*[[${error ?: 'null'}]]*/ 'null';

        if (message !== 'null' && message !== null) {
            showSuccessAlert(message);
        }
        if (error !== 'null' && error !== null) {
            showErrorAlert(error);
        }

        // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
        function showLoading() {
            $("#loading-spinner").css("display", "flex");
        }

        function hideLoading() {
            $("#loading-spinner").hide();
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showSuccessAlert(message) {
            if (message) {
                $("#alert-success").text(message).show().delay(3000).fadeOut();
            }
        }

        function showErrorAlert(message) {
            if (message) {
                $("#alert-danger").text(message).show().delay(3000).fadeOut();
            }
        }

            // ë‹¤ì‹œ ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ë¦¬í”Œë ˆì´ URL ì €ì¥ (ìˆ˜ì •ë¨)
            $("#reservation-again-btn").click(function() {
                showLoading();

                // ğŸ”§ ìˆ˜ì •: ë¦¬í”Œë ˆì´ ë³µì‚¬ë¥¼ ì„ íƒì ìœ¼ë¡œ ë§Œë“¤ê¸°
                const shouldCopyReplays = confirm("ê¸°ì¡´ ë¦¬í”Œë ˆì´ë¥¼ ìƒˆ ì˜ˆì•½ì— ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

                if (shouldCopyReplays) {
                    // í˜„ì¬ ë¦¬í”Œë ˆì´ URLë“¤ localStorageì— ì €ì¥
                    const replayUrls = [];
                    $(".view-replay").each(function() {
                        const url = $(this).attr('data-url');
                        if (url) {
                            replayUrls.push(url);
                        }
                    });

                    if (replayUrls.length > 0) {
                        console.log("ë‹¤ìŒ ë¦¬í”Œë ˆì´ URLë“¤ì„ ìƒˆ ì˜ˆì•½ì— ì¶”ê°€:", replayUrls);
                        localStorage.setItem('pendingReplayUrls', JSON.stringify(replayUrls));
                    }
                } else {
                    // ë¦¬í”Œë ˆì´ ë³µì‚¬ ì•ˆí•¨ - localStorage ì •ë¦¬
                    localStorage.removeItem('pendingReplayUrls');
                }
            });

            // ğŸ”§ ì¶”ê°€: ì˜ˆì•½ ì·¨ì†Œ ì‹œ localStorage ì •ë¦¬
            $("#reservation-cancel-btn").click(function() {
                // localStorage ì™„ì „ ì •ë¦¬
                localStorage.removeItem('pendingReplayUrls');
                localStorage.removeItem('refreshAfterCancel');
                localStorage.setItem('refreshAfterCancel', 'true');
            });
        // âœ… ìˆ˜ì •ëœ .view-replay í´ë¦­ ì´ë²¤íŠ¸ (ì˜ˆì•½ í¼ê³¼ ë™ì¼í•˜ê²Œ ìˆ˜ì •)
        $(document).on("click", ".view-replay", function(e) {
            e.preventDefault();
            console.log("=== ë²„íŠ¼ í´ë¦­ë¨! ===");

            const $this = $(this); // ğŸ”§ ìˆ˜ì •: $this ë³€ìˆ˜ë¥¼ ì œëŒ€ë¡œ ì •ì˜
            const url = $this.attr('data-url');
            console.log('URL:', url);

            if (!url) {
                console.error('URLì´ ì—†ìŠµë‹ˆë‹¤');
                showErrorAlert('ë¦¬í”Œë ˆì´ URLì´ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }

            const replayItem = $this.closest('.replay-item');
            const previewContainer = replayItem.find('.item-preview-container');

            console.log("ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ ì¡´ì¬:", previewContainer.length);

            // í† ê¸€ ì²˜ë¦¬ - í˜„ì¬ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ìˆ¨ê¸°ê¸°
            if (previewContainer.is(":visible")) {
                console.log("ë¯¸ë¦¬ë³´ê¸° í† ê¸€: ë‹«ê¸°");
                previewContainer.hide();
                previewContainer.empty();
                $this.removeClass("active");
                return false;
            }

            // ë‹¤ë¥¸ ëª¨ë“  ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸° ë° ë²„íŠ¼ ë¹„í™œì„±í™”
            console.log("ë‹¤ë¥¸ ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°");
            $(".item-preview-container").not(previewContainer).hide().empty();
            $(".view-replay").not($this).removeClass("active");

            // í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            $this.addClass("active");

            const embedUrl = getYouTubeEmbedUrl(url);
            console.log("ì„ë² ë“œ URL:", embedUrl);

            if (embedUrl) {
                console.log("ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì‹œì‘");
                const iframe = `<iframe src="${embedUrl}" frameborder="0" allowfullscreen style="width: 100%; height: 400px; border: none;"></iframe>`;
                previewContainer.html(iframe);
                previewContainer.show();

                // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜
                console.log("ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘");
                $('html, body').animate({
                    scrollTop: previewContainer.offset().top - 100
                }, 500);

                console.log("ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì™„ë£Œ");
            } else {
                console.error("ìœ íš¨í•œ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤");
                showErrorAlert("ìœ íš¨í•œ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤");
            }

            return false;
        });

        // YouTube URLì„ ì„ë² ë“œ URLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function getYouTubeEmbedUrl(url) {
            if (!url) return null;

            let videoId = null;

            // URL ë””ë²„ê¹…
            console.log("ë³€í™˜í•  URL:", url);

            // ì¼ë°˜ YouTube URL (watch?v=VIDEO_ID)
            if (url.includes('youtube.com/watch?v=')) {
                const urlParts = url.split('?');
                if (urlParts.length > 1) {
                    const urlParams = new URLSearchParams(urlParts[1]);
                    videoId = urlParams.get('v');
                }
            }
            // ë‹¨ì¶• URL (youtu.be/VIDEO_ID)
            else if (url.includes('youtu.be/')) {
                const parts = url.split('youtu.be/');
                if (parts.length > 1) {
                    videoId = parts[1];
                    // URLì— ì¶”ê°€ íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ì œê±°
                    if (videoId.includes('?')) {
                        videoId = videoId.substring(0, videoId.indexOf('?'));
                    }
                }
            }

            console.log("ì¶”ì¶œëœ Video ID:", videoId);

            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}`;
            }

            return null;
        }

        // í˜ì´ì§€ ë¡œë“œ í›„ ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
        setTimeout(function() {
            console.log("=== ë””ë²„ê¹… ì •ë³´ ===");
            console.log("ì „ì²´ ë¦¬í”Œë ˆì´ ë²„íŠ¼ ê°œìˆ˜:", $(".view-replay").length);

            $(".view-replay").each(function(index) {
                const url = $(this).attr('data-url');
                console.log(`ë¦¬í”Œë ˆì´ ${index + 1} URL:`, url);
            });
            console.log("================");
        }, 1000);
    });
</script>
</body>
</html>