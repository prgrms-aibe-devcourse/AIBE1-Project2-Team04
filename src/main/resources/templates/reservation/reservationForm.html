<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì˜ ì˜ˆì•½</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background: #fafbfc; margin: 0; }
        .container { max-width: 1200px; margin: 40px auto; padding: 20px; }
        .section { background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px #0001; margin-bottom: 24px; }
        .section-title { font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; }
        .section-subtitle { font-size: 1.1rem; font-weight: bold; margin-bottom: 16px; color: #444; }
        .price { font-size: 1.2rem; color: #2e7dff; font-weight: bold; }
        .form-label { display: block; margin: 16px 0 8px; font-weight: 500; }
        .form-input, .form-textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .btn-box { display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px; }
        .btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95rem; border: none; }
        .btn-primary { background: #2e7dff; color: #fff; }
        .btn-secondary { background: #f1f2f6; color: #333; }
        .btn-success { background: #2ecc71; color: #fff; }
        .replay-list { margin-top: 20px; }
        .replay-item { background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px; position: relative; }
        .replay-item-title { font-weight: 500; margin-bottom: 8px; }
        .replay-item-actions { position: absolute; right: 16px; top: 16px; display: flex; gap: 8px; }
        .btn-icon { background: none; border: none; color: #2e7dff; cursor: pointer; font-size: 1.1rem; }
        .btn-icon:hover { color: #0056b3; }
        .btn-icon.active { color: #ff6b6b; }
        .replay-form { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        /* ë¯¸ë¦¬ë³´ê¸° ì°½ ë†’ì´ ì¦ê°€ */
        .preview-container { margin-top: 20px; width: 100%; height: 450px; display: none; }
        .preview-container iframe { width: 100%; height: 100%; border: none; border-radius: 8px; }
        /* ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ - ê° ë¦¬í”Œë ˆì´ í•­ëª© ë‚´ë¶€ì— ìœ„ì¹˜ */
        .item-preview-container {
            margin-top: 15px;
            width: 100%;
            display: none;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .item-preview-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
        .submit-container { margin-top: 40px; display: flex; justify-content: center; }
        .submit-btn { padding: 15px 40px; font-size: 1.1rem; background: #2e7dff; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
        .submit-btn:hover { background: #185bb5; }
        .replay-controls { display: flex; gap: 10px; }
        .replay-controls button { padding: 8px 16px; border-radius: 4px; font-size: 0.9rem; }
        /* ë¡œë”© í‘œì‹œê¸° */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: white;
        }
        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .alert {
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div id="loading-spinner" class="loading-spinner">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container">
    <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
    <div id="alert-success" class="alert alert-success" role="alert"></div>
    <div id="alert-danger" class="alert alert-danger" role="alert"></div>

    <!-- ê°•ì˜ ì •ë³´ ì„¹ì…˜ -->
    <div class="section">
        <h2 class="section-title" th:text="${lecture.info.title}">ê°•ì˜ëª…</h2>
        <p th:text="${lecture.info.description}">ê°•ì˜ ì„¤ëª…</p>
        <div class="price" th:text="${lecture.info.price} + 'ì›'">14,000ì›</div>
    </div>

    <!-- ì˜ˆì•½ ì •ë³´ ì„¹ì…˜ -->
    <div class="section">
        <h2 class="section-title">ì˜ˆì•½ ì •ë³´</h2>
        <form id="reservationForm" th:action="@{/reservation}" th:object="${reservationRequestDto}" method="post" enctype="multipart/form-data">
            <input type="hidden" th:field="*{memberId}" />
            <input type="hidden" th:field="*{lectureId}" />
            <input type="hidden" th:field="*{instructorId}" />

            <label class="form-label">ìš”ì²­ì‚¬í•­</label>
            <textarea th:field="*{requestDetail}" class="form-textarea" placeholder="ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>

            <label class="form-label">ê°•ì˜ ì¼ì • ì„ íƒ</label>
            <input type="text" id="scheduleDate" th:field="*{scheduleDate}" class="form-input" readonly placeholder="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”"/>

            <!-- ë¦¬í”Œë ˆì´ URLì„ ì €ì¥í•˜ê¸° ìœ„í•œ hidden input -->
            <div id="replayUrlsContainer"></div>
        </form>
    </div>

    <!-- ë¦¬í”Œë ˆì´ ê´€ë¦¬ ì„¹ì…˜ -->
    <div class="section">
        <h2 class="section-title">ë¦¬í”Œë ˆì´ ê´€ë¦¬</h2>
        <p>ê°•ì˜ ë¦¬í”Œë ˆì´ë¥¼ ì—…ë¡œë“œí•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. ì—¬ëŸ¬ ê°œì˜ ë¦¬í”Œë ˆì´ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <!-- ë¦¬í”Œë ˆì´ ëª©ë¡ -->
        <div id="replay-list" class="replay-list">
            <!-- ê¸°ì¡´ ë¦¬í”Œë ˆì´ í•­ëª©ë“¤ (ìˆëŠ” ê²½ìš°) -->
            <div th:if="${existingReplays != null && !existingReplays.isEmpty()}"
                 th:each="replay, replayStat : ${existingReplays}"
                 class="replay-item"
                 th:data-id="${replay.replayId}">
                <div class="replay-item-title" th:text="'ë¦¬í”Œë ˆì´ ' + (${replayStat.index} + 1)"></div>
                <div class="replay-item-actions">
                    <button type="button" class="btn-icon view-replay" th:data-url="${replay.fileUrl}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn-icon edit-replay"
                            th:data-id="${replay.replayId}"
                            th:data-url="${replay.fileUrl}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn-icon delete-replay"
                            th:data-id="${replay.replayId}"
                            th:attr="data-existing-id=${replay.replayId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <!-- ê° ë¦¬í”Œë ˆì´ í•­ëª©ë§ˆë‹¤ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
                <div class="item-preview-container"></div>
            </div>
        </div>

        <!-- ë¦¬í”Œë ˆì´ ì¶”ê°€ ë²„íŠ¼ -->
        <button type="button" id="add-replay-btn" class="btn btn-primary" style="margin-top: 20px;">
            <i class="fas fa-plus"></i> ë¦¬í”Œë ˆì´ ì¶”ê°€
        </button>

        <!-- ìƒˆ ë¦¬í”Œë ˆì´ í¼ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
        <div id="new-replay-form" class="replay-form" style="display: none;">
            <h3 class="section-subtitle">ìƒˆ ë¦¬í”Œë ˆì´ ì¶”ê°€</h3>

            <label class="form-label">YouTube URL</label>
            <input type="text" id="youtube-url" class="form-input" placeholder="YouTube ì˜ìƒ URLì„ ì…ë ¥í•˜ì„¸ìš”">

            <div class="replay-controls">
                <button type="button" id="preview-btn" class="btn btn-secondary">
                    <i class="fas fa-eye"></i> ë¯¸ë¦¬ë³´ê¸°
                </button>
                <button type="button" id="save-replay-btn" class="btn btn-success">
                    <i class="fas fa-save"></i> ì €ì¥
                </button>
                <button type="button" id="cancel-replay-btn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> ì·¨ì†Œ
                </button>
            </div>

            <!-- ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ - ë†’ì´ ì¦ê°€ë¨ -->
            <div id="preview-container" class="preview-container"></div>
        </div>
    </div>

    <!-- ì˜ˆì•½ ì™„ë£Œ ë²„íŠ¼ (ë§¨ ì•„ë˜ë¡œ ì´ë™) -->
    <div class="submit-container">
        <button type="button" class="submit-btn" id="submit-reservation">ì˜ˆì•½ì™„ë£Œ</button>
    </div>
</div>

<script>
    $(function() {
            // ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™”
            $("#scheduleDate").datepicker({
                dateFormat: "yy-mm-dd",
                minDate: 0
            });

            // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
            function showLoading() {
                $("#loading-spinner").css("display", "flex");
            }

            function hideLoading() {
                $("#loading-spinner").hide();
            }

            // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
            function showSuccessAlert(message) {
                $("#alert-success").text(message).show().delay(3000).fadeOut();
            }

            function showErrorAlert(message) {
                $("#alert-danger").text(message).show().delay(3000).fadeOut();
            }

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì €ì¥ëœ ë¦¬í”Œë ˆì´ URL ë¶ˆëŸ¬ì˜¤ê¸° (ìˆ˜ì •ë¨)
            const loadSavedReplays = function() {
                const savedReplayUrls = localStorage.getItem('pendingReplayUrls');
                if (savedReplayUrls) {
                    try {
                        const replayUrls = JSON.parse(savedReplayUrls);
                        console.log("ì €ì¥ëœ ë¦¬í”Œë ˆì´ URLs ë¶ˆëŸ¬ì˜´:", replayUrls);

                        replayUrls.forEach((url, index) => {
                            if (url) {
                                // ê¸°ì¡´ ë¦¬í”Œë ˆì´ ê°œìˆ˜ë¥¼ íŒŒì•…í•˜ì—¬ ìˆœë²ˆ ì •í•˜ê¸°
                                const existingCount = $(".replay-item").length;
                                const replayNum = existingCount + index + 1;

                                // ğŸ”§ ìˆ˜ì •: ì •ìƒì ì¸ ì œëª© ìƒì„± (ì´ìƒí•œ ID ì—†ì• ê¸°)
                                const replayId = 'temp_' + (index + 1);

                                // ìƒˆ ë¦¬í”Œë ˆì´ í•­ëª© ì¶”ê°€ (ì •ìƒì ì¸ ì œëª©ìœ¼ë¡œ)
                                const replayItem = `
                                    <div class="replay-item" data-id="${replayId}">
                                        <div class="replay-item-title">ë¦¬í”Œë ˆì´ ${replayNum}</div>
                                        <div class="replay-item-actions">
                                            <button type="button" class="btn-icon view-replay" data-url="${url}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn-icon edit-replay" data-id="${replayId}" data-url="${url}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn-icon delete-replay" data-id="${replayId}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="item-preview-container"></div>
                                    </div>
                                `;

                                $("#replay-list").append(replayItem);
                                $("#replayUrlsContainer").append(`<input type="hidden" name="replayUrls" value="${url}" />`);
                            }
                        });

                        // ğŸ”§ ì¤‘ìš”: ì‚¬ìš© í›„ ì¦‰ì‹œ ì‚­ì œ
                        localStorage.removeItem('pendingReplayUrls');
                    } catch (e) {
                        console.error("ì €ì¥ëœ ë¦¬í”Œë ˆì´ URL ë¡œë“œ ì˜¤ë¥˜:", e);
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ localStorage ì •ë¦¬
                        localStorage.removeItem('pendingReplayUrls');
                    }
                }
            };

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—¬ëŸ¬ ì¤‘ë³µ ë°©ì§€
            let replayLoadExecuted = false;
            $(document).ready(function() {
                if (!replayLoadExecuted) {
                    loadSavedReplays();
                    replayLoadExecuted = true;
                }
            });

            // ğŸ”§ ì¶”ê°€: ì¤‘ë³µ ë° ì´ìƒí•œ ë¦¬í”Œë ˆì´ ì •ë¦¬ í•¨ìˆ˜
            function cleanupReplays() {
                const seenUrls = new Set();
                const itemsToRemove = [];

                $('.replay-item').each(function(index) {
                    const $item = $(this);
                    const url = $item.find('.view-replay').attr('data-url');
                    const title = $item.find('.replay-item-title').text();

                    // ì¤‘ë³µ URL ë˜ëŠ” ì´ìƒí•œ ì œëª© í™•ì¸
                    if (seenUrls.has(url) || title.includes('#') || title.length > 20) {
                        itemsToRemove.push($item);
                        return;
                    }

                    seenUrls.add(url);
                });

                // ì´ìƒí•œ í•­ëª©ë“¤ ì œê±°
                itemsToRemove.forEach($item => {
                    const url = $item.find('.view-replay').attr('data-url');
                    $item.remove();
                    $(`input[name="replayUrls"][value="${url}"]`).remove();
                });

                // ì œëª© ìˆœì„œ ì •ë¦¬
                $('.replay-item').each(function(index) {
                    $(this).find('.replay-item-title').text(`ë¦¬í”Œë ˆì´ ${index + 1}`);
                });
            }

            // í˜ì´ì§€ ë¡œë“œ í›„ ì •ë¦¬ ì‹¤í–‰
            setTimeout(cleanupReplays, 1000);
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë¦¬í”Œë ˆì´ URL ë¶ˆëŸ¬ì˜¤ê¸°
            loadSavedReplays();

            // ë¦¬í”Œë ˆì´ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            $("#add-replay-btn").click(function() {
                // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ì´ˆê¸°í™”
                $("#preview-container").hide();
                $(".item-preview-container").hide().empty();
                $(".view-replay").removeClass("active");

                // í¸ì§‘ ëª¨ë“œ ì´ˆê¸°í™”
                $("#save-replay-btn").removeData("edit-id");

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                $("#youtube-url").val("");

                // í¼ í‘œì‹œ
                $("#new-replay-form").show();
            });

            // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            $("#cancel-replay-btn").click(function() {
                $("#new-replay-form").hide();
                $("#preview-container").hide();
            });

            // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (í¼ ë‚´ì˜ ë¯¸ë¦¬ë³´ê¸°)
            $("#preview-btn").click(function() {
                const youtubeUrl = $("#youtube-url").val().trim();
                if (!youtubeUrl) {
                    showErrorAlert("YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const embedUrl = getYouTubeEmbedUrl(youtubeUrl);
                console.log("ì„ë² ë“œ URL:", embedUrl);

                if (embedUrl) {
                    console.log("ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ");
                    $("#preview-container").html(`<iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`);
                    $("#preview-container").show();
                    $("#preview-container").data("current-url", youtubeUrl);
                } else {
                    showErrorAlert("ìœ íš¨í•œ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤.");
                }
            });

            // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            $("#save-replay-btn").click(function() {
                const youtubeUrl = $("#youtube-url").val().trim();
                if (!youtubeUrl) {
                    showErrorAlert("YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                // í¸ì§‘ ëª¨ë“œ í™•ì¸
                const editId = $(this).data("edit-id");

                if (editId) {
                    // ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸
                    const item = $(`.replay-item[data-id="${editId}"]`);
                    const oldUrl = item.find(".view-replay").data("url");

                    item.find(".view-replay").data("url", youtubeUrl);
                    item.find(".edit-replay").data("url", youtubeUrl);

                    // hidden input ì—…ë°ì´íŠ¸
                    $(`input[name="replayUrls"][value="${oldUrl}"]`).val(youtubeUrl);

                    // í¸ì§‘ ëª¨ë“œ í•´ì œ
                    $(this).removeData("edit-id");

                    showSuccessAlert("ë¦¬í”Œë ˆì´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    // ìƒˆ í•­ëª© ì¶”ê°€ ëª¨ë“œ
                    const replayId = Date.now(); // ì„ì‹œ ID

                    // í˜„ì¬ ì¡´ì¬í•˜ëŠ” ë¦¬í”Œë ˆì´ ì•„ì´í…œ ê°œìˆ˜ íŒŒì•…
                    const currentCount = $(".replay-item").length + 1;

                    const replayItem = `
                        <div class="replay-item" data-id="${replayId}">
                            <div class="replay-item-title">ë¦¬í”Œë ˆì´ ${currentCount}</div>
                            <div class="replay-item-actions">
                                <button type="button" class="btn-icon view-replay" data-url="${youtubeUrl}"><i class="fas fa-eye"></i></button>
                                <button type="button" class="btn-icon edit-replay" data-id="${replayId}" data-url="${youtubeUrl}"><i class="fas fa-edit"></i></button>
                                <button type="button" class="btn-icon delete-replay" data-id="${replayId}"><i class="fas fa-trash"></i></button>
                            </div>
                            <div class="item-preview-container"></div>
                        </div>
                    `;

                    $("#replay-list").append(replayItem);

                    // hidden input ì¶”ê°€
                    $("#replayUrlsContainer").append(`<input type="hidden" name="replayUrls" value="${youtubeUrl}" />`);

                    showSuccessAlert("ë¦¬í”Œë ˆì´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }

                $("#new-replay-form").hide();
                $("#preview-container").hide();
            });

            // âœ… í†µí•©ëœ .view-replay í´ë¦­ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ì „íŒŒ ë¬¸ì œ í•´ê²°)
            $(document).on("click", ".view-replay", function(e) {
                e.preventDefault();
                e.stopImmediatePropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì™„ì „ ì°¨ë‹¨

                console.log("ëˆˆ ì•„ì´ì½˜ í´ë¦­ë¨");

                const $this = $(this);
                const url = $this.data("url");
                const replayItem = $this.closest(".replay-item");
                const previewContainer = replayItem.find(".item-preview-container");

                console.log("URL:", url);
                console.log("ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ ì¡´ì¬:", previewContainer.length);

                // í† ê¸€ ì²˜ë¦¬ - í˜„ì¬ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ìˆ¨ê¸°ê¸°
                if (previewContainer.is(":visible")) {
                    console.log("ë¯¸ë¦¬ë³´ê¸° í† ê¸€: ë‹«ê¸°");
                    previewContainer.hide();
                    previewContainer.empty();
                    $this.removeClass("active");
                    return false;
                }

                // ë‹¤ë¥¸ ëª¨ë“  ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸° ë° ë²„íŠ¼ ë¹„í™œì„±í™”
                console.log("ë‹¤ë¥¸ ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°");
                $(".item-preview-container").not(previewContainer).hide().empty();
                $(".view-replay").not($this).removeClass("active");

                // í¼ ë‚´ì˜ ë¯¸ë¦¬ë³´ê¸°ë„ ë‹«ê¸°
                $("#preview-container").hide();

                // í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                $this.addClass("active");

                const embedUrl = getYouTubeEmbedUrl(url);
                console.log("ì„ë² ë“œ URL:", embedUrl);

                if (embedUrl) {
                    console.log("ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì‹œì‘");
                    const iframe = `<iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
                    previewContainer.html(iframe);
                    previewContainer.show();

                    // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜
                    console.log("ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘");
                    $('html, body').animate({
                        scrollTop: previewContainer.offset().top - 100
                    }, 500);

                    console.log("ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì™„ë£Œ");
                } else {
                    console.error("ìœ íš¨í•œ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤");
                    showErrorAlert("ìœ íš¨í•œ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤");
                }

                return false;
            });

            // í¸ì§‘ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸
            $(document).on("click", ".edit-replay", function() {
                const id = $(this).data("id");
                const url = $(this).data("url");

                // ìˆ˜ì • í¼ ì„¤ì • ë° í‘œì‹œ
                $("#youtube-url").val(url);
                $("#new-replay-form").show();

                // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                const embedUrl = getYouTubeEmbedUrl(url);
                if (embedUrl) {
                    $("#preview-container").html(`<iframe src="${embedUrl}" allowfullscreen></iframe>`);
                    $("#preview-container").data("current-url", url);
                    $("#preview-container").show();
                }

                // ëª¨ë“  ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°
                $(".item-preview-container").hide().empty();
                $(".view-replay").removeClass("active");

                // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë¦¬í”Œë ˆì´ ID ì €ì¥
                $("#save-replay-btn").data("edit-id", id);
            });

            // âœ… ìˆ˜ì •ëœ ì‚­ì œ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸
            $(document).on("click", ".delete-replay", function(e) {
                e.preventDefault();
                e.stopPropagation();

                if (confirm("ì´ ë¦¬í”Œë ˆì´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    const $button = $(this);
                    const item = $button.closest(".replay-item");
                    const url = item.find(".view-replay").data("url");

                    // ìˆ˜ì •: HTML ì†ì„±ìœ¼ë¡œ ì ‘ê·¼
                    const existingReplayId = $button.attr("data-existing-id");
                    const currentItemId = item.data("id");

                    console.log("ì‚­ì œ ì‹œì‘ - existingReplayId:", existingReplayId, "currentItemId:", currentItemId);

                    // UIì—ì„œ í•­ëª© ì œê±°
                    item.remove();
                    $(`input[name="replayUrls"][value="${url}"]`).remove();

                    // ê¸°ì¡´ ë¦¬í”Œë ˆì´ì¸ ê²½ìš° ì„œë²„ ì‚­ì œ ìš”ì²­
                    if (existingReplayId) {
                        $.ajax({
                            url: `/replays/${existingReplayId}`,
                            type: 'DELETE',
                            success: function(response) {
                                console.log("ë¦¬í”Œë ˆì´ ì‚­ì œ ì„±ê³µ:", response);
                                showSuccessAlert("ë¦¬í”Œë ˆì´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            },
                            error: function(xhr, status, error) {
                                console.error("ë¦¬í”Œë ˆì´ ì‚­ì œ ì‹¤íŒ¨:", error);
                                showErrorAlert("ë¦¬í”Œë ˆì´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            }
                        });
                    } else {
                        console.log("ìƒˆë¡œ ì¶”ê°€ëœ ë¦¬í”Œë ˆì´ - UIì—ì„œë§Œ ì œê±°");
                        showSuccessAlert("ë¦¬í”Œë ˆì´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }

                    // ë¯¸ë¦¬ë³´ê¸°ê°€ í˜„ì¬ ì´ ì˜ìƒì„ ë³´ì—¬ì£¼ê³  ìˆë‹¤ë©´ ë‹«ê¸°
                    if ($("#preview-container").data("current-url") === url) {
                        $("#preview-container").hide();
                    }

                    $("#new-replay-form").hide();
                }

                return false;
            });

            // âœ… ì˜ˆì•½ ì™„ë£Œ í›„ ìƒˆë¡œê³ ì¹¨ ì²˜ë¦¬
            $("#submit-reservation").click(function(e) {
                e.preventDefault();

                // ë‚ ì§œ ì„ íƒ ê²€ì¦
                if (!$("#scheduleDate").val()) {
                    showErrorAlert("ê°•ì˜ ì¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
                showLoading();

                // ìƒˆë¡œê³ ì¹¨ í”Œë˜ê·¸ ì„¤ì •
                localStorage.setItem('refreshAfterSubmit', 'true');

                // ì¼ë°˜ í¼ ì œì¶œ
                $("#reservationForm").submit();
            });

            // YouTube URLì„ ì„ë² ë“œ URLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
            function getYouTubeEmbedUrl(url) {
                if (!url) return null;

                let videoId = null;

                // URL ë””ë²„ê¹…
                console.log("ë³€í™˜í•  URL:", url);

                // ì¼ë°˜ YouTube URL (watch?v=VIDEO_ID)
                if (url.includes('youtube.com/watch?v=')) {
                    const urlParts = url.split('?');
                    if (urlParts.length > 1) {
                        const urlParams = new URLSearchParams(urlParts[1]);
                        videoId = urlParams.get('v');
                    }
                }
                // ë‹¨ì¶• URL (youtu.be/VIDEO_ID)
                else if (url.includes('youtu.be/')) {
                    const parts = url.split('youtu.be/');
                    if (parts.length > 1) {
                        videoId = parts[1];
                        // URLì— ì¶”ê°€ íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ì œê±°
                        if (videoId.includes('?')) {
                            videoId = videoId.substring(0, videoId.indexOf('?'));
                        }
                    }
                }

                console.log("ì¶”ì¶œëœ Video ID:", videoId);

                if (videoId) {
                    return `https://www.youtube.com/embed/${videoId}`;
                }

                return null;
            }
        });
</script>
</body>
</html>